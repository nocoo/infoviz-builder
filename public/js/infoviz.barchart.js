define(function(b,a,c){b.async(["infoviz.core"],function(d){a.draw_barchart=function(f,t,ab,F,Q,O){if(!f||!ab){return idb("Paper or Data is empty.")}var B=d.merge_options(F),u=[],R,P,X=0;var K=ab.data,z=[],C=[],aa,Z,Y,H;var E=ab.horizontal_field,g=ab.vertical_field;var l,ac,D=Infinity,ad=-Infinity,M=Infinity,q=-Infinity;for(var r in K){for(aa=0;aa<K[r]["data"].length;++aa){H=K[r]["data"][aa];if(H[E]!==undefined){l=H[E]}else{l="N/A"}if(l>ad){ad=l}if(l<D){D=l}if(d.in_array(l,z)===-1){z.push(l)}if(d.isNumber(H[g])){ac=H[g]}else{ac="N/A"}if(ac>q){q=ac}if(ac<M){M=ac}if(d.in_array(ac,C)===-1){C.push(ac)}}++X}M=Math.floor(M/10)*10;q=Math.ceil(q/10)*10;var U=t["top-left"][0]+B.barchart["padding-left"];var W=t["bottom-left"][1]-B.barchart["padding-bottom"];var N=(W-t["top-left"][1]-B.barchart["padding-top"])/(q-M);var h={};var v=(W-t["top-left"][1]-B.barchart["padding-top"])/(B.barchart["vertical-label-count"]-1);var n=Math.floor((q-M)/(B.barchart["vertical-label-count"]-1));u=[];R=t["top-left"][0]-B.barchart["vertical-bar-width"];P=W;var m=M;for(aa=0;aa<B.barchart["vertical-label-count"];++aa){u.push("M"+R+","+P+"L"+t["top-left"][0]+","+P);f.path(u.join("")).attr({stroke:B.grid["axis-color"],"stroke-opacity":B.grid["axis-alpha"],"stroke-width":B.grid["axis-width"]}).translate(0.5,0.5);f.text(R-B.barchart["vertical-bar-width"],P,m).attr({"text-anchor":"end",fill:B.grid["vertical-label-color"],"font-size":B.grid["vertical-label-size"]}).translate(0.5,0.5);P-=v;m+=n}var A=(t.width-B.barchart["padding-left"]-B.barchart["padding-right"]-(z.length-1)*B.barchart["group-margin"])/z.length;var L=(A-(X-1)*B.barchart["bar-margin"])/X;var o;u=[];R=U+A/2;P=t["bottom-right"][1]+B.grid["horizontal-name-size"]/2+B.grid["horizontal-label-margin"]*2;for(aa=0;aa<z.length;++aa){u.push("M"+R+","+t["bottom-left"][1]);u.push("L"+R+","+t["top-left"][1]);h[z[aa]]=R-A/2;f.text(R,P,z[aa]).attr({"text-anchor":"middle","font-size":B.grid["horizontal-label-size"],fill:B.grid["horizontal-label-color"]}).translate(0.5,0.5);R+=A+B.barchart["group-margin"]}o=f.path(u.join(""));o.attr({stroke:B.grid["grid-color"],"stroke-dasharray":"--..","stroke-linecap":"butt","stroke-width":B.grid["grid-width"],"stroke-opacity":B.grid["grid-alpha"]});o.translate(0.5,0.5);var J=0,G,e=[],T;var S=[];for(var r in K){var w;G=B.color[(J%B.color.length)];for(aa=0;aa<K[r]["data"].length;++aa){H=K[r]["data"][aa];R=h[H[E]]+(J)*(L+B.barchart["bar-margin"]);P=W-(H[g]-M)*N;T=f.rect(R,P,L,t["bottom-left"][1]-P-1);T.attr({stroke:G.color,"stroke-opacity":G["dark-alpha"],"stroke-width":B.barchart["border-width"],fill:G.color,"fill-opacity":G["light-alpha"]}).translate(0.5,0.5);e.push(T);if(Q&&typeof(Q)==="function"){T.data("info",{x:R,y:P,h_value:H[E],v_value:H[g],data:H,that:O,callback:Q});T.click(d.element_action)}if(ab.tooltip_title||ab.tooltip_content){var I=ab.tooltip_title;var s=ab.tooltip_content;for(var V in H){I=I.replace("{"+V+"}",H[V]);s=s.replace("{"+V+"}",H[V])}T.data("tooltip",{id:r+aa,title:I,content:s,color:G,x:R+L/2,y:P,element:T,options:B,paper:f});T.hover(d.element_tooltip)}}S.push({label:K[r]["name"],color:G,type:"box"});J++}d.draw_legend(f,t,S,B);for(aa=0;aa<e.length;++aa){(function(i){i.mouseover(function(){i.stop().animate({"fill-opacity":B.color[0]["dark-alpha"]},B.layout["speed"],">")});i.mouseout(function(){i.stop().animate({"fill-opacity":B.color[0]["light-alpha"]},B.layout["speed"],"<")})})(e[aa])}}})});