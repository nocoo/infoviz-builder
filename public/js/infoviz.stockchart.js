define(function(b,a,c){b.async(["infoviz.core"],function(d){a.draw_stockchart=function(f,v,aj,I,V,S){if(!f||!aj){return idb("Paper or Data is empty.")}var F=d.merge_options(I),z=[],W,U,ak,af=0;var O=aj.data,D=[],ai,ah,ag,K;var H=aj.horizontal_field,g=aj.vertical_field;var m,h,T,L,G=Infinity,al=-Infinity,Q=Infinity,s=-Infinity;var o={};for(var t in O){for(ai=0;ai<O[t]["data"].length;++ai){K=O[t]["data"][ai];if(K[H]!==undefined){m=K[H]}else{m="N/A"}if(m>al){al=m}if(m<G){G=m}if(d.in_array(m,D)===-1){D.push(m);o[m]={min:Infinity,max:-Infinity}}if(d.isNumber(K[g.max])){h=K[g.max]}else{continue}if(d.isNumber(K[g.min])){L=K[g.min]}else{continue}if(h>o[m]["max"]){o[m]["max"]=h}if(L<o[m]["min"]){o[m]["min"]=L}}++af}for(var Z in o){if(o[Z]["max"]>s){s=o[Z]["max"]}if(o[Z]["min"]<Q){Q=o[Z]["min"]}}Q=Math.floor(Q/10)*10;s=Math.ceil(s/10)*10;var aa=v["top-left"][0]+F.stockchart["padding-left"];var ae=v["bottom-left"][1]-F.stockchart["padding-bottom"];var R=(ae-v["top-left"][1]-F.stockchart["padding-top"])/(s-Q);var l={};var A=(ae-v["top-left"][1]-F.stockchart["padding-top"])/(F.stockchart["vertical-label-count"]-1);var q=Math.floor((s-Q)/(F.stockchart["vertical-label-count"]-1));z=[];W=v["top-left"][0]-F.stockchart["vertical-bar-width"];U=ae;var n=Q;for(ai=0;ai<F.stockchart["vertical-label-count"];++ai){z.push("M"+W+","+U+"L"+v["top-left"][0]+","+U);f.path(z.join("")).attr({stroke:F.grid["axis-color"],"stroke-opacity":F.grid["axis-alpha"],"stroke-width":F.grid["axis-width"]}).translate(0.5,0.5);f.text(W-F.stockchart["vertical-bar-width"],U,n).attr({"text-anchor":"end",fill:F.grid["vertical-label-color"],"font-size":F.grid["vertical-label-size"]}).translate(0.5,0.5);U-=A;n+=q}var E=(v.width-F.stockchart["padding-left"]-F.stockchart["padding-right"]-(D.length-1)*F.stockchart["group-margin"])/D.length;var P=(E-(af-1)*F.stockchart["bar-margin"])/af;var r;z=[];W=aa+E/2;U=v["bottom-right"][1]+F.grid["horizontal-name-size"]/2+F.grid["horizontal-label-margin"]*2;for(ai=0;ai<D.length;++ai){z.push("M"+W+","+v["bottom-left"][1]);z.push("L"+W+","+v["top-left"][1]);l[D[ai]]=W-E/2;f.text(W,U,D[ai]).attr({"text-anchor":"middle","font-size":F.grid["horizontal-label-size"],fill:F.grid["horizontal-label-color"]}).translate(0.5,0.5);W+=E+F.stockchart["group-margin"]}r=f.path(z.join(""));r.attr({stroke:F.grid["grid-color"],"stroke-dasharray":"--..","stroke-linecap":"butt","stroke-width":F.grid["grid-width"],"stroke-opacity":F.grid["grid-alpha"]});r.translate(0.5,0.5);var N=0,J,e=[],Y;var X=[];for(var t in O){var C,w,B,ad;J=F.color[(N%F.color.length)];for(ai=0;ai<O[t]["data"].length;++ai){K=O[t]["data"][ai];W=l[K[H]]+(N)*(P+F.stockchart["bar-margin"]);ad=ae-(K[g.max]-Q)*R;B=ae-(K[g.middle]-Q)*R;w=ae-(K[g.min]-Q)*R;Y=f.rect(W,ad,P,(w-ad));Y.attr({stroke:J.color,"stroke-opacity":J["dark-alpha"],"stroke-width":F.stockchart["border-width"],fill:J.color,"fill-opacity":J["light-alpha"]}).translate(0.5,0.5);e.push(Y);var ab=F.stockchart["middle-line-color"];if(!ab){ab=J.color}f.path("M"+(W-F.stockchart["bar-margin"])+","+B+"L"+(W+P+F.stockchart["bar-margin"])+","+B).attr({stroke:ab,"stroke-width":F.stockchart["middle-line-width"],"stroke-opacity":F.stockchart["middle-line-alpha"]}).translate(0.5,0.5);if(V&&typeof(V)==="function"){Y.data("info",{x:W,min_y:w,middle_y:B,max_y:ad,h_value:K[H],v_value:K[g],data:K,callback:V,that:S});Y.click(d.element_action)}if(aj.tooltip_title||aj.tooltip_content){var M=aj.tooltip_title;var u=aj.tooltip_content;for(var ac in K){M=M.replace("{"+ac+"}",K[ac]);u=u.replace("{"+ac+"}",K[ac])}Y.data("tooltip",{id:t+ai,title:M,content:u,color:J,x:W,y:ad,element:Y,options:F,paper:f});Y.hover(d.element_tooltip)}}X.push({label:O[t]["name"],color:J,type:"box"});N++}d.draw_legend(f,v,X,F);for(ai=0;ai<e.length;++ai){(function(i){i.mouseover(function(){i.stop().animate({"fill-opacity":F.color[0]["dark-alpha"]},F.layout["speed"],">")});i.mouseout(function(){i.stop().animate({"fill-opacity":F.color[0]["light-alpha"]},F.layout["speed"],"<")})})(e[ai])}}})});