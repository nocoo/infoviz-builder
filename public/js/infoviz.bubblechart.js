define(function(b,a,c){b.async(["infoviz.core"],function(d){a.draw_bubblechart=function(f,r,W,E,O,K){if(!f||!W){return idb("Paper or Data is empty.")}var B=d.merge_options(E),s=[],V,Q,N,o,G;var C=Infinity,Z=-Infinity,I=Infinity,n=-Infinity,g=-Infinity,F=Infinity;for(V=0;V<W.data.length;++V){G=W.data[V];if(G[W.horizontal_field]>Z){Z=G[W.horizontal_field]}if(G[W.horizontal_field]<C){C=G[W.horizontal_field]}if(G[W.vertical_field]>n){n=G[W.vertical_field]}if(G[W.vertical_field]<I){I=G[W.vertical_field]}if(G[W.size_field]>g){g=G[W.size_field]}if(G[W.size_field]<F){F=G[W.size_field]}}C=Math.floor(C/10)*10;Z=Math.ceil(Z/10)*10;I=Math.floor(I/10)*10;n=Math.ceil(n/10)*10;var S=r["top-left"][0]+B.bubblechart["padding-left"];var A=(r["top-right"][0]-B.bubblechart["padding-right"]-S)/(Z-C);var U=r["bottom-left"][1]-B.bubblechart["padding-bottom"];var J=(U-r["top-left"][1]-B.bubblechart["padding-top"])/(n-I);var Y=B.bubblechart["circle-min-radius"];var w=(B.bubblechart["circle-max-radius"]-Y)/(g-F);var k,X,v,P,z,u,L;var R=[],D=[],h=[];for(V=0;V<W.data.length;++V){G=W.data[V];k=G[W.horizontal_field];X=G[W.vertical_field];v=G[W.size_field];P=G[W.label_field];z=B.color[(V%B.color.length)];o=Y+v*w;Q=S+(k-C)*A;N=U-(X-I)*J;u=f.circle(Q,N,o).attr({fill:z.color,"fill-opacity":z["light-alpha"],stroke:z.color,"stroke-opacity":z["dark-alpha"],"stroke-width":B.bubblechart["circle-border-width"]}).translate(0.5,0.5);L=f.text(Q,N,P).attr({fill:B.bubblechart["label-color"],"font-size":B.bubblechart["label-size"],"text-anchor":"middle"}).translate(0.5,0.5);u.data("data",G);L.data("data",G);D.push(u);h.push(L);R.push({label:P,color:z,type:"circle"});if(O&&typeof(O)==="function"){u.data("info",{x:Q,y:N,v_value:X,h_value:k,data:G,type:"circle",callback:O,that:K});u.click(d.element_action);L.data("info",{x:Q,y:N,v_value:X,h_value:k,data:G,type:"label",callback:O,that:K});L.click(d.element_action)}if(W.tooltip_title||W.tooltip_content){var H=W.tooltip_title;var q=W.tooltip_content;for(var T in G){H=H.replace("{"+T+"}",G[T]);q=q.replace("{"+T+"}",G[T])}L.data("tooltip",{id:V,title:H,content:q,color:z,x:Q,y:N-o,element:L,options:B,paper:f});L.hover(d.element_tooltip)}}d.draw_legend(f,r,R,B);var t=(U-r["top-left"][1]-B.bubblechart["padding-top"])/(B.bubblechart["vertical-label-count"]-1);var m=(n-I)/(B.bubblechart["vertical-label-count"]-1);s=[];Q=r["top-left"][0]-B.bubblechart["vertical-bar-width"];N=U;var l=I;for(V=0;V<B.bubblechart["vertical-label-count"];++V){s.push("M"+Q+","+N+"L"+r["top-left"][0]+","+N);f.path(s.join("")).attr({stroke:B.grid["axis-color"],"stroke-opacity":B.grid["axis-alpha"],"stroke-width":B.grid["axis-width"]}).translate(0.5,0.5);f.text(Q-B.bubblechart["vertical-bar-width"],N,l.toFixed(2)).attr({"text-anchor":"end",fill:B.grid["vertical-label-color"],"font-size":B.grid["vertical-label-size"]}).translate(0.5,0.5);N-=t;l+=m}var M=(r["top-right"][0]-B.bubblechart["padding-right"]-S)/(B.bubblechart["vertical-label-count"]-1);var e=(Z-C)/(B.bubblechart["vertical-label-count"]-1);s=[];Q=S;N=r["bottom-left"][1]+B.bubblechart["horizontal-bar-width"];var j=C;for(V=0;V<B.bubblechart["horizontal-label-count"];++V){s.push("M"+Q+","+N+"L"+Q+","+r["bottom-left"][1]);f.path(s.join("")).attr({stroke:B.grid["axis-color"],"stroke-opacity":B.grid["axis-alpha"],"stroke-width":B.grid["axis-width"]}).translate(0.5,0.5);f.text(Q,N+B.bubblechart["horizontal-bar-width"]*2,j.toFixed(2)).attr({fill:B.grid["horizontal-label-color"],"font-size":B.grid["horizontal-label-size"]}).translate(0.5,0.5);Q+=M;j+=e}}})});