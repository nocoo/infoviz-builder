define(function(b,a,c){b.async(["infoviz.core"],function(d){a.draw_stackchart=function(f,v,af,I,S,Q){if(!f||!af){return idb("Paper or Data is empty.")}var E=d.merge_options(I),w=[],T,R,aa=0;var N=af.data,C=[],F=[],ad,ac,ab,K;var H=af.horizontal_field,h=af.vertical_field;var m,ag,O=Infinity,s=-Infinity,ah=-Infinity;var n={};for(var t in N){for(ad=0;ad<N[t]["data"].length;++ad){K=N[t]["data"][ad];if(K[H]!==undefined){m=K[H]}else{m="N/A"}if(d.in_array(m,C)===-1){C.push(m);n[m]=0}if(d.isNumber(K[h])){ag=K[h]}else{ag="N/A"}if(d.in_array(ag,F)===-1){F.push(ag)}n[m]+=ag}++aa}for(var W in n){if(n[W]>ah){ah=n[W]}}O=0;s=Math.ceil(ah/10)*10;var X=v["top-left"][0]+E.stackchart["padding-left"];var Z=v["bottom-left"][1]-E.stackchart["padding-bottom"];var P=(Z-v["top-left"][1]-E.stackchart["padding-top"]-E.stackchart["bar-margin"]*(aa-1))/ah;var l={};var z=(Z-v["top-left"][1]-E.stackchart["padding-top"])/(E.stackchart["vertical-label-count"]-1);var q=Math.floor((ah-O)/(E.stackchart["vertical-label-count"]-1));w=[];T=v["top-left"][0]-E.stackchart["vertical-bar-width"];R=Z;var o=O;for(ad=0;ad<E.stackchart["vertical-label-count"];++ad){w.push("M"+T+","+R+"L"+v["top-left"][0]+","+R);f.path(w.join("")).attr({stroke:E.grid["axis-color"],"stroke-opacity":E.grid["axis-alpha"],"stroke-width":E.grid["axis-width"]}).translate(0.5,0.5);f.text(T-E.stackchart["vertical-bar-width"],R,o).attr({"text-anchor":"end",fill:E.grid["vertical-label-color"],"font-size":E.grid["vertical-label-size"]}).translate(0.5,0.5);R-=z;o+=q}var D=(v.width-E.stackchart["padding-left"]-E.stackchart["padding-right"]-(C.length-1)*E.barchart["group-margin"])/C.length;var r;w=[];T=X+D/2;R=v["bottom-right"][1]+E.grid["horizontal-name-size"]/2+E.grid["horizontal-label-margin"]*2;for(ad=0;ad<C.length;++ad){w.push("M"+T+","+v["bottom-left"][1]);w.push("L"+T+","+v["top-left"][1]);l[C[ad]]=T-D/2;f.text(T,R,C[ad]).attr({"text-anchor":"middle","font-size":E.grid["horizontal-label-size"],fill:E.grid["horizontal-label-color"]}).translate(0.5,0.5);T+=D+E.stackchart["group-margin"]}r=f.path(w.join(""));r.attr({stroke:E.grid["grid-color"],"stroke-dasharray":"--..","stroke-linecap":"butt","stroke-width":E.grid["grid-width"],"stroke-opacity":E.grid["grid-alpha"]});r.translate(0.5,0.5);var G={};for(var ae in l){G[ae]=Z}var M=0,J,e=[],V;var U=[];for(var t in N){var B,A;J=E.color[(M%E.color.length)];for(ad=0;ad<N[t]["data"].length;++ad){K=N[t]["data"][ad];A=P*K[h];T=l[K[H]];R=G[K[H]]-A-E.stackchart["bar-margin"];V=f.rect(T,R,D,A);V.attr({stroke:J.color,"stroke-opacity":J["dark-alpha"],"stroke-width":E.stackchart["border-width"],fill:J.color,"fill-opacity":J["light-alpha"]}).translate(0.5,0.5);e.push(V);if(S&&typeof(S)==="function"){V.data("info",{x:T,y:R,h_value:K[H],v_value:K[h],data:K,callback:S,that:Q});V.click(d.element_action)}if(af.tooltip_title||af.tooltip_content){var L=af.tooltip_title;var u=af.tooltip_content;for(var Y in K){L=L.replace("{"+Y+"}",K[Y]);u=u.replace("{"+Y+"}",K[Y])}V.data("tooltip",{id:t+ad,title:L,content:u,color:J,x:T+D/2,y:R,element:V,options:E,paper:f});V.hover(d.element_tooltip)}G[K[H]]=R}U.push({label:N[t]["name"],color:J,type:"box"});M++}d.draw_legend(f,v,U,E);for(ad=0;ad<e.length;++ad){(function(g){g.mouseover(function(){g.stop().animate({"fill-opacity":E.color[0]["dark-alpha"]},E.layout["speed"],">")});g.mouseout(function(){g.stop().animate({"fill-opacity":E.color[0]["light-alpha"]},E.layout["speed"],"<")})})(e[ad])}}})});